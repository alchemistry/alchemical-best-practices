%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% LIVECOMS ARTICLE TEMPLATE FOR BEST PRACTICES GUIDE
%%% ADAPTED FROM ELIFE ARTICLE TEMPLATE (8/10/2017)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% PREAMBLE
\documentclass[9pt,bestpractices]{livecoms}
% Use the 'onehalfspacing' option for 1.5 line spacing
% Use the 'doublespacing' option for 2.0 line spacing
% Use the 'lineno' option for adding line numbers.
% The 'bestpractices' option for indicates that this is a best practices guide.
% Omit the bestpractices option to remove the marking as a LiveCoMS paper.
% Please note that these options may affect formatting.

\usepackage{lipsum} % Required to insert dummy text
\usepackage[version=4]{mhchem}
\usepackage{siunitx}
\DeclareSIUnit\Molar{M}
\usepackage[italic]{mathastext}
\graphicspath{{figures/}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% IMPORTANT USER CONFIGURATION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[colorinlistoftodos]{todonotes}
\newcommand{\versionnumber}{0.1}  % you should update the minor version number in preprints and major version number of submissions.
\newcommand{\githubrepository}{\url{https://github.com/michellab/alchemical-best-practices}}  %this should be the main github repository for this article

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% ARTICLE SETUP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{Best Practices for Alchemical Free Energy Calculations: v\versionnumber}

\author[1*]{John D. Chodera}
\author[2*]{Antonia S. J. S. Mey}
\author[2*]{Julien Michel}
\author[3*]{David L. Mobley}
\author[4*]{Conor Parks}
\author[5*]{Julia E. Rice}
\author[6*]{Michael Shirts}
\author[7]{Bryce K. Allen}
\author[1]{Levi N. Naden}
\author[1,9]{Andrea Rizzi}
\affil[1]{Computational and Systems Biology Program, Memorial Sloan Kettering Cancer Center, New York NY, USA}
\affil[2]{EaStCHEM School of Chemistry, David Brewster Road, Joseph Black Building, The King's Buildings, Edinburgh, EH9 3FJ, UK}
\affil[3]{Departments of Pharmaceutical Sciences and Chemistry, University of California, Irvine, USA}
\affil[4]{I don't know my affiliation}
\affil[5]{I don't know my affiliation}
\affil[6]{University of Colorado Boulder, Boulder, CO, USA}
\affil[7]{Silicon Therapeutics, Boston, MA, USA}
\affil[8]{Tri-Institutional Training Program in Computational Biology and Medicine, New York, NY, USA}


\corr{john.chodera@choderalab.org}{JDC}
\corr{dmobley@mobleylab.org}{DLM}
\corr{antonia.mey@ed.ac.uk}{ASJSM}
\corr{info@julienmichel.net}{JM}
\corr{michael.shirts@colorado.edu}{MRS}
\corr{ddd@yyy}{CP}

\contrib[\authfn{1}]{These authors contributed equally to this work}
\contrib[\authfn{2}]{These authors also contributed equally to this work}


\blurb{This LiveCoMS document is maintained online on GitHub at \githubrepository; to provide feedback, suggestions, or help improve it, please visit the GitHub repository and participate via the issue tracker.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% PUBLICATION INFORMATION
%%% Fill out these parameters when available
%%% These are used when the "pubversion" option is invoked
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pubDOI{10.XXXX/YYYYYYY}
\pubvolume{<volume>}
\pubyear{<year>}
\articlenum{<number>}
\datereceived{Month, Day, Year}
\dateaccepted{Month, Day, Year}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% ARTICLE START
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\begin{frontmatter}
\maketitle

\begin{abstract}
%\todo[inline, color={green!20}]{ASJSM: @Volunteer write abstract}
%In your work, in this particular slot, please provide an abstract of no more than 250 words.
%Your abstract should explain the main contributions of your article, and should not contain any material that is not included in the main text.
%Please note that your abstract, plus the authorship material following it, must not extend beyond the title page or modifications to the LaTeX class will likely be needed.
Alchemical free energy calculations can be a useful tool for predicting free energy differences associated with the transfer of small molecules from one environment to another.
The hallmark of these methods is the use of modified potential energy functions to represent \emph{alchemical} intermediate states that cannot exist in chemistry; by analyzing simulation data collected from a series of bridging alchemical thermodynamic states, transfer free energies (or differences in transfer free energies) can be computed with orders of magnitude less simulation time than observing the process spontaneously. 
While these methods are highly flexible, care must be taken in avoiding common pitfalls to ensure that computed free energy differences can be robust and reproducible for the chosen forcefield, and that appropriate corrections are included to permit comparison with experimental data.
In this paper, we review current best practices for several popular application domains of alchemical free energy calculations, including relative and absolute small molecule binding free energy calculations to biomolecular targets.
\todo[inline]{JDC: What about biopolymer mutations?}
\end{abstract}

\end{frontmatter}



\todototoc
\listoftodos

%%%%%%%%%%%%%%%%%%%%
%              Introduction                  %
%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:intro}
Alchemical free energy calculations have become a mature technology for computing various properties related to the transfer of chemical species from one environment to another.
The domain of applicability for these calculations now involves such varied applications as the computation of protein-ligand binding free energies~\cite{binding-free-energies}, ligand selectivities~\cite{selectivity}, partition and distribution coefficients between different liquid phases (such as octanol-water partition coefficients~\cite{octanol-water-partition}), loss of affinity due to resistance mutations~\cite{resistance-mutations}, and changes in protein thermostability due to engineered mutations~\cite{thermostability}.

The defining characteristic of alchemical free energy calculations is the use of a series of modified potential functions $U(x; \lambda)$ in which an alchemical parameter $\lambda$ modulates interactions in a manner that cannot occur in real chemical systems.
One or more simulations are used to collect data from a multitude of alchemical states to compute a free energy difference between a chemical state ($\lambda_0$) and another chemical or alchemical reference state ($\lambda_1$),
\begin{eqnarray}
\Delta f &\equiv& f(\lambda_1) - f(\lambda_0) = - \ln \frac{Z(\lambda_1)}{Z(\lambda_0)}
\end{eqnarray}
where the dimensionless free energy $f(\lambda) \equiv \beta F(\lambda)$ is given in terms of partition functions $Z(\lambda)$,
\begin{eqnarray}
Z(\lambda) &=& \int dx \, e^{-u(x; \lambda)} .
\end{eqnarray}
Here, the inverse temperature $\beta \equiv (k_B T)^{-1}$ where $k_B$ is the Boltzmann constant, and the \emph{reduced potential} $u(x; \lambda)$~\cite{reduced-potential} is generally given by a trace over thermodynamic parameters with their conjugate dynamical variables,
\begin{eqnarray}
u(x;\lambda) &\equiv& \beta \left[ U(x;\lambda) + p \, V(x) + \sum_{i=1}^N \mu_i N_i(x) + \cdots \right]
\end{eqnarray}
where the collection of thermodynamic and alchemical parameters $\theta \equiv \{\beta, \lambda, p, \mu, \ldots\}$ defines a \emph{thermodynamic state}.
The physical transformation of interest may require several free energy differences $\Delta f$ to be computed in order to produce an estimate of the overall desired quantity.

%%%%%%%%%%%%%%%%%%%%
%              Prerequesites                %
%%%%%%%%%%%%%%%%%%%%
\section{Prerequisites}
\label{sec:pre}
%Here you would identify prerequisites/background knowledge that are assumed by your work and your checklist which you view as critical, ideally giving links to good sources on these topics.
%Checklists are normally focused on errors made by users with training and experience in molecular simulations, so you can assume a basic familiarity with the fundamentals of molecular simulations.

Before proceeding with this document, you are assumed to have a basic familiarity with the principles of molecular simulations, molecular dynamics simulations, statistical mechanics and thermodynamics, and so on.
This document focuses on aspects specific to alchemical free energy calculations, which remain an advanced topic within the molecular simulations area.
Thus, if you are a beginner in the area of molecular simulations, not all background you need will be covered within the scope of this document.
For example, we assume that you are able to set up and conduct a successful equilibrium molecular dynamics simulation of a particular thermodynamic state of a system interest as a prerequisite for this document.

\section{Scope and Goals}
\label{sec:scope}

This document focuses on preparation, execution, and analysis of alchemical free energy calculations, especially on aspects of the molecular simulations used here which are unique to alchemical calculations.
A particular focus is on calculation of transfer free energies (hydration free energies, partition coefficients, etc.) and binding free energies (absolute and relative).

Not within our scope are advanced ligand binding topics such as:

\begin{itemize}
\item Covalent inhibition
\item Association which is not 1:1
\item Endpoint free energy methods
\item PMF binding free energy methods
\end{itemize}

Additionally, the choice of force field (for protein, ligand, ions, cosolvents, or cofactors) is outside of the scope of this work; here, we focus on attempting to ensure successful alchemical free energy calculations given a particular choice of system and force field.

\textbf{Goals:}
\begin{itemize}
\item Checklist and background for new practitioners of relative and absolute alchemical free energy calculations: What should you pay attention to in setting up and running calculations in common codes and why.
\item Provide guidance to authors as to what should be reported about their protocols in a Methods section, either conforming to standard or reporting where they did not conform and why. Useful to reviewers as well.
\end{itemize}
\section{Checklist}
\label{sec:checklist}
\todo[inline, color={green!20}]{ASJSM: @Volunteer This needs to be revised and expanded, some initial thoughts were just thrown in.}
An attempt at identifying most important checklist items.


% This provides a checklist which
% - spans a full page
% - consists of multiple sub-checklists
% - exists on a separate page
% This style of checklist will be especially helpful if you want to encourage readers to print and use your checklist in practice, as they
% can easily print it without also printing other material from your manuscript. However, other styles of checklist are also possible (below).
\begin{Checklists*}[p!]

\begin{checklist}{Step 0 -- Know what you want to simulate }
\textbf{What are the first questions that need addressing before setting up a molecular dynamics simulation}\\
Extensive explanation for the checklist questions can be found in section~\ref{sec:step0}.
\begin{itemize}
\item Can I get the required accuracy with the simulation I want to carry out
\item
\item And finally
\end{itemize}
\end{checklist}

\begin{checklist}{Simulation preparation}
\textbf{How do I get started setting up an alchemical free energy calculation}
Extensive explanation for the checklist questions can be found in section~\ref{sec:step1}.
\begin{itemize}
\item Have I followed the Best practices for biomolecular simulation set up?
\item In a relative simulation, will I run into problems with clashing geometries in the ligand transformation or crystal waters?
\end{itemize}
\end{checklist}
\end{Checklists*}

\begin{Checklists*}[p!]
\begin{checklist}{Absolute simulations}
\textbf{What are the main things I need to consider for an absolute alchemical free energy calculation?}
Extensive explanation for the checklist questions can be found in section~\ref{sec:step2}.
\begin{itemize}
\item Topology
\item Restraints
\item Standard state handling
\end{itemize}
\end{checklist}

\begin{checklist}{Relative simulations}
\textbf{What are the main things I need to consider for an relative alchemical free energy calculation?}
Extensive explanation for the checklist questions can be found in section~\ref{sec:step2}.
\begin{itemize}
\item First thing
\item Also remember
\item And finally
\end{itemize}
\end{checklist}

\begin{checklist}{Analysis}
\textbf{This is all about analysis of the simulation}
Extensive explanation for the checklist questions can be found in section~\ref{sec:step4}.
\begin{itemize}
\item Are my simulations converged enough?
\item Am I using the right analysis techniques?
\end{itemize}
\end{checklist}

\end{Checklists*}
\clearpage

\section{Step 0 -- What can be expected from alchemical simulations?}
\label{sec:step0}
\begin{itemize}
\item What level of accuracy you can expect?
\item What timescales and how many transformations can you address given available computational resources?
\item Can you even hope to tackle the problem you are attempting?
\end{itemize}

\section{Step 1 -- Simulation prerequesites}
\label{sec:step1}
\begin{enumerate}
\item Generate geometry of initial state: Reference biomolecular simulation preparation best practices
\item Relative: Generate geometry of final state (Mey)
\begin{itemize}
\item e.g. ligand ideally should not clash with receptor, etc.; satisfy constraints that might be imposed by protocol such as overlapping atoms, etc.
\item reference biomolecular preparation setup practices for placing ligand into binding site, but elaborate on constraints that must be considered for relative free energy calculations
\end{itemize}
\end{enumerate}

\section{Step 2 -- Simulation protocol selection}
\label{sec:step2}

\subsection{Absolute and relative free energy calculations have some differences}

Alchemical free energy calculations can be grouped into two main categories, ``absolute'' and ``relative'' \footnote{The distinction is a bit of a misnomer, since both compute ratios of partition functions relative to another state, and neither computes an absolute free energy.}, which differ in whether they compute properties for a single molecule (absolute) or compare properties of different, usually closely related, molecules (relative).
To use binding as a concrete example, in absolute binding free energy calculations, one computes the binding free energy of a ligand to an individual receptor relative to a standard reference concentration.
In contrast, in relative binding free energy calculations, one compares the binding free energy of two related inhibitors to determine the potency difference.

Many protocol issues for alchemical calculations are common, but some are different between absolute and relative calculations, so before treating the common elements we treat the protocol differences.

\subsubsection{Relative free energy calculations must select a topology and produce an atom mapping}

\paragraph{Topologies and atom mappings.} A critical first step in relative calculations is to select an approach to these calculations, determining whether to use a dual topology, single topology, or hybrid topology approach to relative calculations.
%Need figure?  Perhaps adapt http://www.alchemistry.org/wiki/Constructing_a_Pathway_of_Intermediate_States
The distinction between these can be illustrated by considering a hypothetical transformation from molecule A to molecule B, where both atoms share a common substructure but differ in which functional groups are present; e.g. consider a transformation of ethane (A) to methanol (B).
In this case the common substructure is at least CH3, though perhaps may be larger depending on how it is defined, as we discuss below.
In single topology calculations, the overall transformation is set up to involve as few additional atoms as possible, so ethane would be typically changed into methanol by changing two of the protons into non-interacting atoms called ``dummy atoms'' (retaining their bonded interactions but not interacting with the rest of the system) and the connected carbon mutated into an oxygen (with an associated change in the C-H bond parameters as the atoms change to an O-H).
Thus in a single topology calculation, atoms may change their type so relatively few dummy atoms are created.
In contrast, in a dual topology free energy calculation, no atoms are allowed to change type [ref Shirts book chapter in Computational Drug Discovery and Design] so the ethane to methanol transformation involves starting with ethane plus two non-interacting dummy atoms, then passing through an intermediate state where atoms which are becoming dummy atoms or ceasing being dummy atoms are partially interacting (this state may or may not be well defined [ref Mobley perspective]), and culminating in a state where methane is present along with three additional dummy atoms which were previously a corresponding methyl group of ethane.
%referneced http://www.alchemistry.org/wiki/Constructing_a_Pathway_of_Intermediate_States
Hybrid topology calculations have not seen much use [ref] but essentially consist of two absolute free energy calculations in opposite directions at the same time (turning one molecule off while turning the other on), and are best considered in that light.
At present, the most widely used approaches, such as in Schrodinger's FEP+[ref] and in FESetup[ref] (for which calculations may be planned with Lead Optimization Mapper (LOMAP) [refs]) seem to use single topology approaches, though some codes only support dual topology.
To our knowledge efficiency differences have not been thoroughly explored, though conventional wisdom would suggest that fewer dummy atoms are better [ref LOMAP paper/Mobley perspective].

Once a particular approach to the topology is selected, a crucial next step is to identify the common atoms which will not be perturbed.
Rigorously, this process essentially comprises a maximal common substructure (MCSS) search of the molecules involved to identify the common substructure -- though the parameters of the MCSS search will differ depending on whether single or dual topology calculations are planned.
Specifically, with a single topology approach in mind, atom types are allowed to change, so a permissive MCSS search can be done, whereas with dual topology a more strict search is required.
Some tools automate this process; for example, LOMAP can take a set of ligands and generate proposed pairings of molecules which are scored by their MCSS similarity and other properties [refs].
Schr\"{o}dinger's FEP+ planning tool is based on a version of LOMAP [ref].

MCSS searches can be relatively time consuming, so if scoring a library of ligands to identify promising pairs for relative calculations is the goal, it can be helpful to use faster approaches such as shape similarity to perform an initial scoring and then use MCSS only to identify final mappings for relative calculations.

The MCSS approach, though relatively standard, takes into account only topological similarity.
It is possible that changes in binding mode could actually require a different choice of mapping, so in some cases mappings may need to be planned differently depending on 3D positioning of atoms in space [ref; does Cournia paper address this?].

Single topology relative calculations, and calculations based on substructure searches, only work if in fact the ligands share a common substructure.
If no common substructure is shared, then essentially one ends up needing sophisticated dual or hybrid topology free energy calculations, where one would co-localize a pair of compounds in a binding site, exclude their interactions with one another, and compute the relative binding free energy by turning one molecule on from being dummy atoms while turning the other off.
To our knowledge no general pipeline for such calculations yet exists and this would likely remain a research problem.

\paragraph{Ring breaking and forming.} Relative free energy calculations for ring breaking and forming are particularly challenging/problematic, in part because relative calculations rely on the free energy contributions of dummy atoms canceling between different legs of the thermodynamic cycle [refs], which may not be true whenever dummy atoms are involved in rings.
Some approaches have attempted to address this [ref Schrodinger] but a general solution is not yet in mainstream use.

\paragraph{Constraints and relative free energy calculations.}
One issue which requires particular care is the use of constraints.
Commonly, bonds involving hydrogen are constrained to a fixed length to allow the use of longer timesteps.
However, in single topology relative free energy calculations, the atoms involved might be mutated to other atom types -- for example, in a mutation of methane to methanol, one hydrogen might become an oxygen atom.
Typical molecular dynamics engines are not set up to recognize this change, or at least not to correctly include contributions to the free energy from changing constraints/constraint length, so results for a transformation would usually be erroneous.
At present the most general solution to this problem is simply to avoid the use of constraints (and thus use a smaller timestep if necessary) in any relative free energy calculation involving a transformation of a constrained bond.

\subsubsection{Absolute free energy calculations must handle the standard state and use restraints}
\label{sec:standardstate-restraints}

\todo[inline, color={red!40}]{LNN: complete discussion about Boresch restraints}

\todo[inline, color={red!40}]{AR: would the explanation in the next paragraph be better suited for a more general section?}

Absolute free energy calculations involve completely removing the interactions between the ligand or solute and its environment, taking it to a non-interacting state that may or may not retain intramolecular nonbonded interactions.
This non-interacting state can then be shifted between environments (from the protein to water, or from one solution to another) without changing its free energy, and then interactions can be restored.

Absolute free energies are typically reported with respect to a specific reference or standard state, which effectively determines the arbitrary point at which the free energy is 0.
The role of the standard state is particularly evident with binding free energies, in which having a reference state allows us to obtain a well-defined partial molar free energy for the reaction
\begin{equation*}
\ce{AB <=> A + B}
\end{equation*}
through the well-known expression derived from the law of mass action
\begin{equation} \label{eq:DGfromKAB}
\Delta G = -RT ~ \text{ln} \left( C^0 K_{AB} \right)  = -RT ~ \text{ln}\left( \frac{C^0 C_{AB}}{C_A C_B} \right) ,
\end{equation}
where $R$ is the gas, $T$ is the temperature, $C_X$ is the equilibrium concentration of the chemical species $X$ in the reaction solvent, and the reference state concentration $C^0$ converts the binding constant $K_{AB}$ into a dimensionless quantity expressed in reference concentration units.
It should be noted that ignoring the term $C^0$ is equivalent to assuming a reference concentration of 1~D$^{-1}$, where D are the units used to express $K_{AB}$, and would thus cause the value of $\Delta G$ to vary with the choice of the units.
Typically, it is convenient to define a standard state at a constant pressure of 1~atm and where each chemical species (i.e., A, B, and AB) in the reaction solvent has a concentration of $C^0$~=~1~M~=~1~molecule/1660~\r{A}$^3$ but do not interact with other molecules of A, B, or AB.

\paragraph{Handling the standard state in absolute free energy calculations.}

For solvation free energy calculations, handling the standard state is typically straightforward, and treating it correctly simply means ensuring that the non-interacting solute is taken to the same (or equivalent) final reference state in both environments, e.g. that the transformation involves a 1M to 1M equivalent transfer free energy (where the non-interacting solute still occupies essentially the same volume as the solute in the interacting system).
So typically in such cases no special care is required to ensure the correct standard state, as long as the \emph{experimental} data being analyzed uses the same standard state and if it does not, a simple entropic correction is needed.

However, for binding the situation is much more complex and requires special care.
Experimental absolute binding free energies are reported relative to a specific reference state -- a 1 M standard state -- which must also be used in calculations.
In practice, this has implications for how the calculations are done, as the reference concentration must enter the thermodynamic cycle employed.


Typically, to deal with both practical sampling issues and the standard state issue, restraints are employed in absolute binding free energy calculations to keep the ligand in a well defined volume as its interactions with the system are removed [ref Gilson 1997 BPJ].
This solves two problems.
First, if the ligand were not kept in a well-defined region, as its interactions were removed it might wander the system, perhaps quite slowly, and only inadequately sample the noninteracting or weakly interacting state -- yet adequate sampling of these states might be required for convergence.
So for practical purposes, the use of restraints can dramatically improve sampling as interactions are weakened and removed.
Second, if the ligand is not kept in a well-defined region then it is hard to determine how to link a computed binding free energy to the correct 1M standard state.
In contrast, with restraints, the free energy of releasing the restrained ligand to a 1M standard state can be computed analytically or numerically by solving the relevant integral [refs], allowing the standard state to enter the thermodynamic cycle [refs].

\paragraph{Several choices of restraints are possible.}
In practice, a variety of types of restraints are common, from simple harmonic distance restraints between the ligand and the protein [refs], to flat-bottom restraints which work similarly but only exert a force if the ligand leaves a specific region [refs].
\todo[inline, color={blue!20}]{DLM: Enlist Naden to discuss problems with analytical approximation to standard-state correction for Boresch restraints}
Alternatively, a set of restraints proposed by Boresch have also commonly been employed, where all six rigid-body degrees of freedom governing the orientation of the ligand relative to the receptor are restrained [refs].
Further restraints, such as on the overall ligand RMSD have also been used [ref Roux].

In principle, all of these forms will yield correct binding free energies in the limit of adequate sampling (if their effects and connection to the standard state are correctly handled) but they have different strengths and weaknesses.
For example, with more involved restraints, sampling at intermediate lambda values will not likely need to be as extensive but more computational effort must go to computing the restraining free energy.
Additionally, such restraints would typically keep the ligand from exploring alternative binding modes, which may be undesirable with Hamiltonian lambda exchange or expanded ensemble techniques where allowing the ligand to exchange binding modes when it is non-interacting could provide sampling benefits [refs, including Yank docs].
Concretely, flat bottom restraints might allow a ligand to explore multiple binding sites, harmonic restraints multiple binding modes within a site, and Boresch restraints a single binding mode within a single site [ref Yank docs?].
See additional discussion of the possibility of multiple binding modes below~\ref{sec:multiple_binding_modes}.

Many choices of restraints involve selecting reference atoms.
Again, in principle this choice is unimportant given adequate simulation time but practical considerations may be important.
The choice is likely especially important with Boresch-style restraints, where some relative placements of reference atoms are likely to be numerically unstable; additionally, ligand reference atoms should likely be in a part of the molecule which defines the binding orientation well, rather than in a floppy solvent-exposed tail, for example.
\todo[inline, color={blue!20}]{DLM: Get input from JDC on what they've learned about these.}

\todo[inline, color={blue!20}]{DLM: Clarify terminology: Double decoupling, etc. See Feature Box below.}


\subsection{Absolute and relative calculations must deal with some of the same issues}

\subsubsection{Structural definition of the bound state and weak binders}

In binding free energy calculations, extra care should be taken when simulating the bound state, especially when dealing with weak binders and absolute free energy calculations in combination with enhanced sampling techniques.
In principle, only configurations of the receptor-ligand complex that we consider "bound" should be sampled from the bound state, and, in atomistic simulations, this requires to establish a structural definition of the bound state.
In practice, the simulation of the bound state starts with the ligand already placed in the binding site and relies on kinetic trapping to maintain a bound complex.
However, this strategy may not be sufficient if the complex dissociation rate is high or if methodologies such as Hamiltonian replica exchange [ref] and expanded ensemble [ref] are employed in absolute free energy calculations to enhance sampling since, in both cases, the ligand may find a way out of the binding site on timescales that are achievable by modern MD simulations.
A solution commonly adopted in these cases is the use of one or more restraints making the unbound configurations energetically unfavorable through the addition of extra terms in the potential function.
In practice, even with restraints, it is not always trivial to force a molecular dynamics simulation to explore a restricted region of the configurational space with a complicated geometry such as a binding site.
If the ligand is a tight binder\todo[inline, color={red!40}]{AR: Should we give an order of magnitude to define a tight and a weak binder?}, it is usually safe to employ a restraint that allows some of the unbound configurations to be sampled since they generally contribute negligibly to the partition function (i.e., they have a relatively small Boltzmann weight) as long as the sampled volume is not so large that their cumulative contribution becomes significant.
However, this is more problematic when dealing with weak binders as the unbound configurations can have a non-negligible Boltzmann weight, and their binding affinity can exhibit a significant dependency on the restraint type and parameters that are used to determine the sampled volume [ref].
Moreover, it should be noted that the additional potential energy terms used to model the restraints can introduce a bias in the predicted free energy.
The bias can be removed at the analysis stage through reweighting techniques, but this procedure can increase the statistical uncertainty of the binding free energy estimate when the restraints are so strong that the overlap with the reweighted state is diminished [ref].

Finally, it is useful to keep in mind that, for a meaningful comparison between computational predictions and experimental measurements, the definition of the bound state should be consistent.
In particular, this means that the signal used by the experimental methodology to determine the fraction of bound complexes in solution should in principle reflect the population of complexes in the bound state as defined in the calculation.

\subsubsection{Changes in net charge can be challenging/problematic.}

If the net charge of the system will change as the alchemical calculation progresses, this can pose major challenges.
Specifically, finite-size effects can introduce profound artifacts into computed binding free energies [refs], in part because typical schemes for long-range electrostatics (including PME and reaction field) do not handle free energy contributions from such changes effectively or as they would be handled in a hypothetical macroscopic bulk solution [refs].

There are two main potential solutions to avoid artifacts due to changes in net charge: Correcting for the introduced artifacts, or avoiding changing the net charge.

Many relative free energy planning tools have been set up to avoid changing the net charge of the systems considered, including LOMAP [ref] and early implementation of Schr\"{o}dinger's FEP+, though later implementations allow changes in net charge by including charge corrections.

Absolute free energy calculations can potentially avoid changing the charge of the system by making a charge perturbation of equal and opposite sign elsewhere in the system; for example, as a charged ligand is removed, a charged counterion of opposite sign could also be removed, or one of the same sign could be inserted.
This is the approach employed by the Yank free energy package [ref].

Charge corrections have also been explored, and are potentially a viable solution to this problem [refs] where artifacts introduced by finite-size effects are corrected numerically.
However, application of such corrections typically remains a research problem (except in the FEP+ protocol [ref]).

When free energy calculations \emph{do} need to change the charge of a ligand or solute, the literature does not yet seem to indicate what approach should be preferable, so considerable care should be taken.
We are not yet aware of a careful comparison of charge corrections versus other approaches such as decoupling an ion at the same time, so in our view the issue of proper handling of charge mutations in the context of alchemical calculations remains a research problem.

\subsubsection{The alchemical pathway is quite important}

\todo[inline, color={red!40}]{LNN: write common principles alchemical path choice}
\todo[inline, color={red!40}]{AR: write absolute-specific section on  alchemical path choice}
\todo[inline, color={red!40}]{BA: write relative-specific section on  alchemical path choice}

Both absolute and relative calculations must choose an alchemical pathway connecting initial and final states, which is in principle arbitrary but in practice affects the efficiency of the calculations considerably.
Some choices are particularly crucial -- for example, transformations involving insertions or deletions of atoms should employ soft-core potentials for Lennard-Jones or other hard-core interactions [refs].
Other issues, such as whether absolute calculations retain intramolecular nonbonded interactions or remove these interactions, may be less critical and differ among studies in the literature [refs].

Relative calculations introduce additional choices, including whether to define explicit intermediate states [ref] or leave these implicitly defined by the code [ref].
Typically in single topology relative calculations it proves most efficient to first remove electrostatic interactions of any atoms which will be deleted, then modify other nonbonded interactions, then restore electrostatic interactions of any atoms which are being inserted.
Other schemes, such as simultaneously changing electrostatic and Lennard-Jones interactions, even with electrostatic ``soft core'' potentials, in our experience typically introduce errors and/or instabilities or are at least unreliable.
We have less experience with dual topology calculations but expect that similar considerations will apply, and the principle of first removing electrostatics and then removing steric interactions will likely serve well.

A key additional consideration in choosing the alchemical pathway is the choice of spacing of intermediate states.
The spacing depends to some extent on the choice of analysis method, though states should essentially be spaced equidistant in the relevant thermodynamic length [ref].
For BAR/MBAR techniques this means that spacings should typically be equal in [what, variance? ref].
Some schemes to adaptively optimize the spacing of intermediate states based on initial exploratory simulations have been proposed [refs].

\begin{enumerate}
\item Choice of discrete alchemical protocol (Shirts, Mey, Chodera)
	%\begin{itemize}
	%\item Many options: Adaptive scheme, Chebyshev polynomials, linear spacing, ``choose your next lambda from data at this lambda'' ��, optimal thermodynamic length approaches (separately: Shirts, Sivak, Huafeng Xu).
	%\item Levi Naden had paper with lambda protocol which worked for all cases -- methane solvation, host-guest (including disappearing host)
	%\end{itemize}
\item Relative
Three-stage protocol (discharge unique initial atoms, transform LJ, charge unique final atoms) vs softcore electrostatics/LJ

\item Absolute
	\begin{itemize}
	\item Select a \textbf{common alchemically-eliminated end state}
	\item Decoupled vs annihilated for electrostatics and LJ
	\item Sequential electrostatics and LJ versus simultaneous (recommend sequential)

\end{itemize}
\item Concerns:
Part of AMBER still can’t run at endpoints (lambda = 0 or 1); SANDER cannot but PMEMD can.

\end{enumerate}


\subsubsection{Multiple or uncertain binding modes may require considerable care}
\label{sec:multiple_binding_modes}

In a discovery setting, new ligands typically have unknown or at least uncertain binding modes [refs, including Mobley Structure paper and recent paper on non-additivity], complicating binding free energy estimation.
This uncertainty is because it is usually not necessary to estimate a binding affinity for a ligand which already has an available bound structure.
To deal with prospective ligands with unknown binding modes, discovery projects commonly assume that modifications of functional groups on a common scaffold result in a consistent binding mode across all members of a series.
This is not necessarily always the case, as reviewed elsewhere [ref Mobley Structure paper] and in some cases unexpected binding mode changes can be the origin of apparent non-additivity in structure-activity relationships [ref non-additivity paper].
Binding modes also tend to be particularly variable in the case of fragments, which often may have multiple relevant binding modes [refs].

Absolute free energy calculations for dissimilar ligands can have particular challenges with binding modes, because the (potentially incorrect) assumption of consistent binding modes across a series of similar ligands provides even less help in this case.
This means that researchers performing absolute binding free energy calculations will have to pay particular attention to generating reasonable putative binding modes.

In some cases, it is tempting to simply use docking techniques to generate initial bound structures for starting molecular dynamics simulations.
However, timescales for binding mode interconversion are usually slow [refs] compared to MD/free energy timescales, meaning that simulations started from different potential binding modes are likely to yield disparate computed binding free energies. [refs]
And docking techniques are good at identifying sterically reasonable potential binding modes, but still perform relatively poorly at identifying a single dominant binding mode \emph{a priori}. [refs] 

It is worth highlighting a recent SAMPL blind challenge on HIV integrase as an illustration of this. 
Many submissions, using state-of-the-art methods, had difficulty even predicting which \emph{binding site} ligands would bind in (most submissions placed more than half of the ligands into the incorrect binding site), and even given correct binding sites, the binding mode within each site was also quite difficult to predict [refs].
The best performing submission for predicting binding modes actually ended up being a human expert with more than 10 years of experience on the particular target [ref], rather than an algorithm.
While free energy calculations on this set had some success, many of the failures actually ended up being cases where the binding mode selected as input for free energy calculations was later found to be incorrect [ref Levy], highlighting the importance of these issues.

One approach which has shown some success is to retain diverse potential binding modes from docking, perform short MD simulations of these to identify distinct stable binding modes, and then consider these in subsequent calculations [refs].

Routes to handle multiple potential binding modes are different depending on whether absolute or relative calculations are selected, unless a method is available to estimate the relative populations of different stable binding modes in advance (e.g. such as the BLUES approach currently in development [ref]), in which case this approach could be applied to assist both types of calculations.



\paragraph{Handling multiple potential binding modes within absolute calculations.}
Within absolute binding free energy calculations, multiple potential binding modes can be handled by two main strategies: Consider each binding mode separately (a separation of states strategy) or sample all binding modes within a single simulation.
This couples to the choice of restraints selected, as some restraints will allow transitions between binding modes and even binding sites (Section~\ref{sec:standardstate-restraints}), and others do not.

Sampling all binding modes within a single free energy calculation is usually impractical without some form of enhanced sampling or at least Hamiltonian replica exchange [refs] because barriers for binding mode interconversion result in kinetics which are too slow compared to simulation timescales [refs].
Hamiltonian exchange, coupled with appropriate restraints, can allow the ligand to relatively rapidly exchange between potential binding modes when non-interacting, accelerating sampling of binding modes [ref Kai Wang, Yank, ...].

Separation of states provides a simple though potentially expensive alternative, where each stable binding mode is considered separately with a binding free energy calculation restricted to that binding mode, and then (as long as the binding modes are non-overlapping) the resulting component binding free energies can be combined into a total [refs].
This approach necessitates a separate binding free energy calculation for each potential binding mode, however, so it can be computationally quite costly.
If relative populations of different stable binding modes were available from some other technique, it could make this separation of states approach considerably more efficient [refs].

\paragraph{Handling multiple potential binding modes within relative calculations.}

Multiple potential binding modes pose particular problems for relative free energy calculations, as having multiple starting structures for these calculations could yield substantially different calculated relative binding free energies for the same transformation due to kinetic trapping, and, without additional information (specifically, the free energy of binding mode interconversion or, equivalently, the relative populations of different binding modes) it becomes impossible to sort out which of the multiple answers is in fact the correct relative binding free energy [refs].

To deal with this, some practitioners have actually computed relative binding free energies of different binding modes of the same ligand [ref Palma, Jorgensen (?) etc.].
For example, a mutation which adds a methyl to an aromatic ring of a larger ligand might yield one result if the methyl points in one direction, and a different value if it points in the other due to slow ring motions. [e.g. get ref from Sukanya]
One could compute the free energy of turning off the methyl group in one orientation and turning it back on in the other orientation to obtain the free energy difference between the two potential binding modes.
While this approach has precedent, it is relatively difficult to automate at present and requires considerable care.

Overall, this likely means that relative free energy calculations will be susceptible to problems resulting from uncertainty in ligand binding modes until more robust approaches are available to determine dominant binding modes, or the relative populations of different potential binding modes, in advance.


\subsubsection{THE BELOW STUFF SHOULD BECOME SUBSUBSECTIONS OR SUBSECTIONS OR...}

\begin{enumerate}
\todo[inline, color={red!40}]{LNN, BA: write stopping condition section}
\item Determine \textbf{stopping conditions}
Uncertainty-directed stopping criteria can ensure target uncertainty is achieved


\item Select which \textbf{data should be saved and with which frequency}
\begin{itemize}
\item What data to save: dU/dlambda, Delta E’s between neighbor for BAR, between further for MBAR, …
\item BAR captures most of info with well-optimized lambda protocol, but MBAR when perhaps not, except when there are way too many lambda values.
\item Recommend against solely relying on TI when possible
\item Recommend cross-comparing methods (TI (spline, trapezoid, etc.), BAR, MBAR) as diagnosis of trouble
\end{itemize}

\end{enumerate}

\section{Step 3 -- Overview of available analysis techniques}
\label{sec:step3}
\todo[inline, color={red!40}]{JDC, BA: uncertainty estimation section}
\begin{enumerate}
\item Detecting boundary between equilibrated and production regions (Chodera: \url{http://dx.doi.org/10.1021/acs.jctc.5b00784})
\item Decorrelating samples for analysis
\begin{itemize}
\item Subsample different lambdas based on correlation times
\item Ensure all simulations at least 50x correlation time
\end{itemize}
\item Examining output data for common problems with discussions of what exactly to plot or look at; examples of typical curves for dV/dlambda and free energy versus lambda, for example
\begin{itemize}
\item Make sure ligand doesn’t tumble out of binding site (Mey has observed this)
\item Significant discrepancies between different free energy estimators (TI, BAR, MBAR)
\item Poor replica mixing (for replica-exchange)
\item Correlation time as a function of lambda as it would be expected to be a smooth
\item Dependence on initial conformation
\item Torsional analysis: Is it stuck in specific states? Only very rarely transitions?
\item More “usual suspects”
\end{itemize}
\item Estimators for free energies
\begin{itemize}
\item MBAR recommended if all energy differences are available
\item BAR just as good for highly optimized lambda values
\item TI should be roughly concordant, but quadrature error hard to quantify
\item Other variants useful in special circumstances (e.g. Z. Tan stochastic version)
\end{itemize}
\item Computing and reporting uncertainties on free energies
correlated bootstrap v. timeseries analysis
\begin{itemize}
\item Quantifying standard error in dG estimate
\item Varience in dG estimate using multiple methods (TI, DEXP, IEXP, BAR, MBAR, GDEL, etc.)
\item Agreement in dG estimate when repeating calculations with different parameters (random seeds, initial configurations, forcefield, etc.)
\item Calculating differences in free energy change as a function of time
\begin{itemize}
	\item Starting from beginning or end of simulation
	\item Significance of differences in midpoint estimate (High middle error: high uncertainty)
\end{itemize}
\item Ensemble method to combine uncertainties into interpretable weighted metric
\begin{itemize}
	\item Simple normalized metric to determine confidence in calculation
	\item Easily interpreted by chemist/biologist when prioritizing new chemistries
\end{itemize}
\end{itemize}
\item Other considerations for many transformations
Cycle closure error



\end{enumerate}

%%%%%%%%%%%%%%%%%%%%
%              Terminology                  %
%%%%%%%%%%%%%%%%%%%%
\section{Terminology and abbreviations}
\label{sec:tem-abbrev}
\begin{itemize}
\item Feature Box covering major technical terms and abbreviations
\item Examples:
\begin{itemize}
\item EXP, BAR, MBAR
\item Double decoupling, single-topology, dual-topology, hybrid-topology, coupled-topology
\item FEP (free energy peturbation), alchemical, AFE (alchemical free energy)
\end{itemize}
\end{itemize}
%%%%%%%%%%%%%%%%%%%%
%                Software                    %
%%%%%%%%%%%%%%%%%%%%
\section{Available software -- a summary}
\label{sec:software}
\begin{itemize}
\item Commercial:
   \begin{itemize}
    \item FEP+
    \end{itemize}
\item Free or low-cost for academics / commercial for industry:
	\begin{itemize}
	\item CHARMM / DOMDEC / CHARMM-OPENMM
	\item TIES and AMBER FEW? (Peter Coveney)
	\item AMBER / PMEMD
	\end{itemize}
\item Free (libre) open source:
	\begin{itemize}
	\item SIRE
	\item YANK
	\item gromacs
	\item pmx for mutations
	\end{itemize}
\item Setup tools
	\begin{itemize}
	\item FESetup: AMBER, gromacs, Sire
	\item Lomap/Lomap2 : Relative alchemical transformation graph planning
	\end{itemize}
\item Analysis tools:
	\begin{itemize}
	\item Free Energy Workflows: Sire-specific free energy map analysis using weighted path averages
	\url{https://github.com/michellab/freenrgworkflows}
	\item Alchemlyb: Multipackage free energy analysis
	\url{https://github.com/alchemistry/alchemlyb}
	\item pymbar: MBAR implementation, but have to roll your own analysis wrapper
	\url{https://github.com/choderalab/pymbar}
	\end{itemize}
\end{itemize}

\section{Online resources}
\begin{itemize}
\item \url{http://www.ks.uiuc.edu/Training/Workshop/Urbana_2010A/lectures/TCBG-2010.pdf}
\item Basic Ingredients of Free Energy Calculations: A Review (\url{DOI: 10.1002/jcc.21450})
\item Good Practices in Free-Energy Calculations (\url{DOI: 10.1021/jp102971x})
\item Alchemical Free Energy Methods for Drug Discovery: Progress and Challenges (\url{doi: 10.1016/j.sbi.2011.01.011})
\item Alchemistry wiki: \url{http://www.alchemistry.org/wiki/Best_Practices}
\end{itemize}

\section*{Author Contributions}
%%%%%%%%%%%%%%%%
% This section mustt describe the actual contributions of
% author. Since this is an electronic-only journal, there is
% no length limit when you describe the authors' contributions,
% so we recommend describing what they actually did rather than
% simply categorizing them in a small number of
% predefined roles as might be done in other journals.
%
% See the policies ``Policies on Authorship'' section of https://livecoms.github.io
% for more information on deciding on authorship and author order.
%%%%%%%%%%%%%%%%

(Explain the contributions of the different authors here)

% We suggest you preserve this comment:
For a more detailed description of author contributions,
see the GitHub issue tracking and changelog at \githubrepository.

\section*{Other Contributions}
%%%%%%%%%%%%%%%
% You should include all people who have filed issues that were
% accepted into the paper, or that upon discussion altered what was in the paper.
% Multiple significant contributions might mean that the contributor
% should be moved to authorship at the discretion of the a
%
% See the policies ``Policies on Authorship'' section of https://livecoms.github.io for
% more information on deciding on authorship and author order.
%%%%%%%%%%%%%%%

(Explain the contributions of any non-author contributors here)
% We suggest you preserve this comment:
For a more detailed description of contributions from the community and others, see the GitHub issue tracking and changelog at \githubrepository.

\section*{Potentially Conflicting Interests}
%%%%%%%
%Declare any potentially competing interests, financial or otherwise
%%%%%%%

Declare any potentially conflicting interests here, whether or not they pose an actual conflict in your view.

\section*{Funding Information}
%%%%%%%
% Authors should acknowledge funding sources here. Reference specific grants.
%%%%%%%
FMS acknowledges the support of NSF grant CHE-1111111.

\bibliography{livecoms-sample}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\appendix


\end{document}
